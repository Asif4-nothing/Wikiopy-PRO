<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wikiopy Pro - Supabase SPA</title>
  <meta name="description" content="Modern, animated, Supabase essay/topic finder built with vanilla HTML, CSS, and JS." />
  
  <style>
    :root{
      --bg: #f6f7fb; --bg2:#eef1f6; --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --brand:#6366f1; --accent:#a855f7; --ok:#16a34a; --warn:#f59e0b;
      --ring: rgba(99,102,241,.35);
    }
    .dark{ --bg:#0b1020; --bg2:#0b1020; --card:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --line:#1f2a44; --ring: rgba(99,102,241,.45); }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji; color:var(--text); background: linear-gradient(135deg,var(--bg),var(--bg2)); }
    a{ color:inherit }

    /* Layout */
    .container{ max-width:1100px; margin:0 auto; padding:16px }
    header{ position:sticky; top:0; z-index:20; backdrop-filter:saturate(140%) blur(10px); background:color-mix(in srgb, var(--card) 70%, transparent); border-bottom:1px solid var(--line) }
    header .bar{ display:flex; align-items:center; gap:12px; padding:10px 16px }
    .logo{ width:36px; height:36px; border-radius:14px; background: linear-gradient(135deg,var(--brand),var(--accent)); box-shadow:0 6px 18px rgba(99,102,241,.35) }
    .title{ font-weight:800; font-size:20px; letter-spacing:.2px }
    .ghost{ background:none; border:1px solid var(--line); padding:8px; border-radius:12px; cursor:pointer }
    .ghost:hover{ background: rgba(148,163,184,.08) }
    .icon{ width:20px; height:20px; display:inline-block; vertical-align:middle; opacity:.9 }

    /* Search panel */
    .panel{ background:color-mix(in srgb, var(--card) 85%, transparent); border:1px solid var(--line); padding:12px; border-radius:18px; box-shadow: 0 6px 24px rgba(2,6,23,.06) }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .field{ position:relative; flex:1 }
    .input{ width:100%; padding:12px 40px 12px 40px; border:1px solid var(--line); border-radius:12px; background: color-mix(in srgb, var(--bg) 65%, var(--card)); color:var(--text); outline:none }
    .input:focus{ box-shadow:0 0 0 4px var(--ring); border-color: color-mix(in srgb, var(--brand) 40%, var(--line)) }
    .left-icon,.right-btn{ position:absolute; top:50%; transform:translateY(-50%) }
    .left-icon{ left:12px; opacity:.7 }
    .right-btn{ right:8px }

    .pill{ padding:8px 12px; border:1px solid var(--line); border-radius:999px; cursor:pointer; font-size:14px }
    .pill.active{ background:var(--brand); color:white; border-color:var(--brand) }
    .recent{ font-size:13px; opacity:.8; margin-top:6px }

    /* Grid */
    .grid{ display:grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap:14px }
    @media(min-width:700px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)) } }
    @media(min-width:1024px){ .grid{ grid-template-columns: repeat(3, minmax(0,1fr)) } }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:18px; padding:14px; transition: transform .2s ease, box-shadow .2s ease }
    .card:hover{ transform: translateY(-4px); box-shadow: 0 12px 28px rgba(2,6,23,.12) }
    .card-head{ display:flex; gap:12px; align-items:flex-start }
    .blob{ width:46px; height:46px; border-radius:16px; background: linear-gradient(135deg,var(--brand),var(--accent)) }
    .tag{ font-size:12px; padding:4px 8px; border:1px solid var(--line); border-radius:999px }
    .btn{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:none; cursor:pointer }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }

    /* Sections */
    .split{ display:grid; grid-template-columns:1fr; gap:14px }
    @media(min-width:900px){ .split{ grid-template-columns:1fr 1fr } }

    /* Modals */
    dialog{ border:none; border-radius:18px; padding:0; width:min(640px,calc(100% - 32px)); background:var(--card); color:var(--text); box-shadow: 0 20px 60px rgba(2,6,23,.35) }
    .modal-head{ display:flex; align-items:center; gap:8px; padding:14px 16px; border-bottom:1px solid var(--line) }
    .modal-body{ padding:16px }
    .kbd{ border:1px solid var(--line); padding:1px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; font-size:12px }

    /* Utility */
    .muted{ color:var(--muted) }
    .space{ height:8px }
    .mb-1{ margin-bottom:6px } .mb-2{ margin-bottom:10px } .mb-3{ margin-bottom:14px } .mt-2{ margin-top:10px } .mt-3{ margin-top:14px } .mt-6{ margin-top:24px }
    .flex{ display:flex; gap:8px; align-items:center } .grow{ flex:1 }
    .center{ text-align:center }
    .hidden{ display:none }

    /* Animations */
    @keyframes fadeUp { from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }
    .fadeUp{ animation: fadeUp .35s ease both }
    
    /* Login Page Styling (From login.html) */
    .login-body {
        background: linear-gradient(135deg, #1f2937, #4b5563);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: 'Inter', sans-serif;
    }
    .login-body .panel { /* Reuse .panel for login form */
        padding: 24px;
        width: 100%;
        max-width: 448px;
        background: var(--card); /* Ensure panel is visible on dark background */
    }
    .login-body .input {
        padding: 12px;
        margin-bottom: 12px;
        border: 1px solid var(--line);
        border-radius: 8px;
        outline: none;
        background: color-mix(in srgb, var(--bg) 65%, var(--card));
    }
    .login-body .btn {
        width: 100%;
        margin-bottom: 12px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid var(--line);
    }
    .login-body .btn:hover {
        transform: scale(1.02);
        box-shadow: 0px 4px 10px rgba(0,0,0,0.3);
    }
    .login-body .primary {
        background: #4f46e5;
        color: white;
        border-color: #4f46e5;
    }
    .login-body .text-gray-500 { color: var(--muted); }
    .login-body .text-indigo-600 { color: var(--brand); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/tailwind.min.js"></script>
</head>

<body>
  <div id="mainApp" class="hidden">
    <header>
      <div class="bar container">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">Wikiopy <span style="color:var(--brand)">Pro</span></div>
        <div class="grow"></div>
        <button class="ghost" id="helpBtn" title="Help"><svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20Zm0 15a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 17Zm1.2-3.8c-.8.5-1.2.9-1.2 1.8h-2c0-1.8 1.1-2.7 2-3.2c.8-.5 1.2-.9 1.2-1.6c0-.9-.7-1.6-1.7-1.6c-1 0-1.7.7-1.7 1.6H7c0-2.1 1.7-3.6 3.8-3.6s3.8 1.4 3.8 3.5c0 1.7-1 2.6-2.4 3.3Z"/></svg></button>
        <button class="ghost" id="settingsBtn" title="Settings"><svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 8a4 4 0 1 0 .001 8.001A4 4 0 0 0 12 8Zm9.4 4a7.5 7.5 0 0 0-.1-1l2-1.6l-2-3.5l-2.4.7a7.9 7.9 0 0 0-1.7-1l-.3-2.5H9.2L8.9 5.6c-.6.3-1.2.6-1.7 1l-2.4-.7l-2 3.5l2 1.6a7.5 7.5 0 0 0-.1 2l-2 1.6l2 3.5l2.4-.7c.5.4 1.1.7 1.7 1l.3 2.5h4.8l.3-2.5c.6-.3 1.2-.6 1.7-1l2.4.7l2-3.5L21.3 12Z"/></svg></button>
        <button class="ghost" id="themeBtn" title="Toggle theme"><svg class="icon" viewBox="0 0 24 24" id="themeIcon"><path fill="currentColor" d="M12 3a9 9 0 0 0 0 18a9 9 0 0 0 0-18Zm0 16a7 7 0 1 1 0-14a7 7 0 0 1 0 14Z"/></svg></button>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </header>

    <main class="container">
      <section class="panel fadeUp">
        <div class="row">
          <div class="field">
            <svg class="icon left-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M10 2a8 8 0 1 0 4.9 14.3l4.4 4.4l1.4-1.4l-4.4-4.4A8 8 0 0 0 10 2Zm0 14a6 6 0 1 1 0-12a6 6 0 0 1 0 12Z"/></svg>
            <input id="searchInput" class="input" placeholder="Search topics, tags, or categories (press / to focus)" autocomplete="off" />
            <button id="voiceBtn" class="ghost right-btn" title="Voice search"><svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm7-3h-2a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0Z"/></svg></button>
          </div>
          <button id="shareBtn" class="btn" title="Share current search"><svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M14 3l7 7l-7 7v-4H3v-6h11V3Z"/></svg> Share</button>
          <button id="resetBtn" class="btn" title="Reset filters"><svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 6V3L8 7l4 4V8c2.8 0 5 2.2 5 5a5 5 0 0 1-9.9 1H5.1A7 7 0 0 0 12 20a7 7 0 0 0 0-14Z"/></svg> Reset</button>
        </div>
        <div class="row mt-2" id="categoryPills"></div>
        <div id="recentWrap" class="recent hidden"></div>
      </section>

      <section class="grid mt-6" id="results"></section>

      <section class="split mt-6">
        <div class="panel">
          <h3 class="mb-2">Add a New Topic</h3>
          <div class="mb-2"><input id="tTitle" class="input" placeholder="Title *" /></div>
          <div class="mb-2"><input id="tCategory" class="input" placeholder="Category (e.g., Science)" /></div>
          <div class="mb-2"><input id="tTags" class="input" placeholder="Tags (comma separated)" /></div>
          <div class="mb-2"><textarea id="tSummary" class="input" placeholder="Short summary *" rows="4"></textarea></div>
          <div class="mb-2"><input id="tLink" class="input" placeholder="Reference link (optional)" /></div>
          <div class="row"><span class="muted">* required</span><div class="grow"></div><button id="addBtn" class="btn primary">Add Topic</button></div>
        </div>
        <div class="panel">
          <h3 class="mb-2">Favorites</h3>
          <div id="favsEmpty" class="muted">No favorites yet. Star a card to pin it here.</div>
          <ul id="favsList" class="mb-2"></ul>
          <div class="row">
            <button id="exportBtn" class="btn"><svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M5 20h14v-2H5v2Zm7-16l-5 5h3v4h4v-4h3l-5-5Z"/></svg> Export JSON</button>
            <label class="btn" for="importFile"><svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13v6H5v-6H3v8h18v-8h-2ZM11 6.8L8.4 9.4L7 8l5-5l5 5l-1.4 1.4L13 6.8V16h-2V6.8Z"/></svg> Import JSON</label>
            <input id="importFile" type="file" accept="application/json" hidden />
          </div>
        </div>
      </section>

      <footer class="center muted mt-6">Didn’t find your topic? <button id="openHelp" class="btn">Open Help</button></footer>
    </main>

    <dialog id="helpModal">
      <div class="modal-head">
        <div class="title" style="font-size:18px">Help & Feedback</div>
        <div class="grow"></div>
        <button class="ghost" data-close="helpModal" title="Close">✕</button>
      </div>
      <div class="modal-body">
        <p class="muted">Suggest new topics, report a bug, or ask for features. We read everything!</p>
        <textarea id="helpText" class="input mt-2" rows="5" placeholder="Type your suggestion…"></textarea>
        <div class="row mt-2"><span class="muted"><span id="charCount">0</span>/400</span><div class="grow"></div><span class="muted">Autosaved locally</span></div>
        <div class="row mt-2"><button id="sendHelp" class="btn primary">Submit</button><button class="btn" data-close="helpModal">Close</button></div>
        <div id="helpThanks" class="mt-2 muted hidden">Thanks! Your suggestion was recorded.</div>
        <div class="mt-3">
          <strong>Tips</strong>
          <ul>
            <li>Use specific keywords (e.g., photosynthesis cycle diagram).</li>
            <li>Filter by category to narrow results.</li>
            <li>Press <span class="kbd">/</span> to focus search, <span class="kbd">Esc</span> to close dialogs.</li>
          </ul>
        </div>
      </div>
    </dialog>

    <dialog id="settingsModal">
      <div class="modal-head">
        <div class="title" style="font-size:18px">Settings</div>
        <div class="grow"></div>
        <button class="ghost" data-close="settingsModal" title="Close">✕</button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Theme</strong>
          <div class="row mt-2">
            <button class="btn" data-theme="light">Light</button>
            <button class="btn" data-theme="dark">Dark</button>
            <button class="btn" data-theme="system">System</button>
          </div>
        </div>
        <div class="mb-3">
          <strong>Danger Zone</strong>
          <div class="row mt-2">
            <button id="resetDemo" class="btn" style="border-color:#fecaca;color:#b91c1c">Reset Demo Topics</button>
            <button id="clearAll" class="btn" style="border-color:#fecaca;color:#b91c1c">Clear Local Data</button>
          </div>
        </div>
        <div class="muted">All settings are stored locally in your browser.</div>
      </div>
    </dialog>
  </div>
  
  <div id="loginForm" class="login-body hidden">
    <div class="panel fade-in">
        <h2 id="form-title" class="text-2xl font-bold text-center mb-6 text-gray-800">Login</h2>

        <input type="email" id="authEmail" placeholder="Email" class="input w-full p-3 mb-3">
        <input type="password" id="authPassword" placeholder="Password" class="input w-full p-3 mb-3">
        
        <button id="submitBtn" class="btn primary mb-3">Login</button>
        
        <p class="text-center text-sm mb-3">
          <a href="#" id="toggle" class="text-indigo-600 hover:underline">Don't have an account? Sign Up</a>
        </p>
        
        <div class="flex items-center mb-3">
          <hr class="flex-grow border-gray-300">
          <span class="px-2 text-gray-500 text-sm">OR</span>
          <hr class="flex-grow border-gray-300">
        </div>
        
        <button id="fbLogin" class="btn bg-blue-600 text-white border-blue-600">Login with Facebook</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // ***** SUPABASE CONFIG *****
    // NOTE: If you changed the keys in the process, please update them here.
    const SUPABASE_URL = 'https://vkikijklwiktjdeigczq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZraWtpamtsd2lrdGpkZWlnY3pxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDAwOTEsImV4cCI6MjA3NjA3NjA5MX0.x21R-HhRYft6hhx5w7N7EtvZBvZuy9qJVlPrV8nn_wE'; 

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)
    
    // ===================================
    // GLOBAL APP STATE & DOM REFERENCES
    // ===================================
    const $ = (sel, root = document) => root.querySelector(sel)
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel))

    let topics = []
    let favs = []
    let themeOpt = 'system'
    let userId = null 

    const searchInput = $('#searchInput')
    const results = $('#results')
    const loginForm = $('#loginForm') // Reference to the login DIV
    const mainApp = $('#mainApp')   // Reference to the main app DIV
    
    // Auth Form Elements
    const authEmailInput = $('#authEmail');
    const authPasswordInput = $('#authPassword');
    const toggleLink = $('#toggle');
    const formTitle = $('#form-title');
    let isLogin = true; // State for login/signup toggle
    
    // ===================================
    // AUTHENTICATION LOGIC
    // ===================================

    // Function to show the correct view
    function setView(isAuthenticated) {
        if (isAuthenticated) {
            loginForm.classList.add('hidden');
            mainApp.classList.remove('hidden');
            document.body.classList.remove('login-body'); // Remove login background
        } else {
            mainApp.classList.add('hidden');
            loginForm.classList.remove('hidden');
            document.body.classList.add('login-body'); // Apply login background
        }
    }

    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        setView(false); // Show login form
      } else {
        userId = user.id;
        setView(true); // Show main app
        loadTopics(); // Load data after setting view
      }
    }

    // Login/Signup Form Toggle
    toggleLink.addEventListener("click", (e) => {
        e.preventDefault();
        isLogin = !isLogin;
        formTitle.textContent = isLogin ? "Login" : "Sign Up";
        $('#submitBtn').textContent = isLogin ? "Login" : "Sign Up";
    });

    // Login/Signup Submission
    $('#submitBtn').addEventListener("click", async () => {
        const email = authEmailInput.value;
        const password = authPasswordInput.value;
        try {
            let result;
            if (isLogin) {
                result = await supabase.auth.signInWithPassword({ email, password });
            } else {
                result = await supabase.auth.signUp({ email, password });
            }

            if (result.error) throw result.error;
            
            // Fix: Directly check auth after signup/login, assuming email confirmation is OFF
            checkAuth(); 
            
        } catch (error) {
            alert(error.message);
        }
    });

    // Social Login
    $('#fbLogin').addEventListener("click", async () => {
      try {
        const { error } = await supabase.auth.signInWithOAuth({
          provider: 'facebook',
          options: {
            redirectTo: window.location.origin 
          }
        });
        if (error) throw error;
      } catch (error) {
        alert(error.message);
      }
    });

    // Supabase Logout
    $('#logoutBtn').addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut()
      if (error) {
        console.error(error)
        toast('Logout failed')
      } else {
        userId = null;
        topics = [];
        setView(false); 
        toast('Logged out successfully');
      }
    })

    // ===================================
    // THEME & HELPER FUNCTIONS
    // ===================================

    function applyTheme() {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
      const dark = themeOpt === 'dark' || (themeOpt === 'system' && prefersDark)
      document.documentElement.classList.toggle('dark', dark)
      $('#themeIcon').innerHTML = dark
        ? '<path fill="currentColor" d="M12 2a10 10 0 1 0 0 20a8 8 0 0 1 0-20Z"/>'
        : '<path fill="currentColor" d="M6.8 4.8L8.2 3.4 12 7.2l3.8-3.8l1.4 1.4L13.4 8.6l3.8 3.8l-1.4 1.4L12 10l-3.8 3.8l-1.4-1.4l3.8-3.8L5.4 6.2l1.4-1.4Z"/>'
    }

    $('#themeBtn').addEventListener('click', () => {
      themeOpt = themeOpt === 'dark' ? 'light' : themeOpt === 'light' ? 'system' : 'dark'
      localStorage.setItem('wikiopy_theme', themeOpt);
      applyTheme()
    })

    function loadLocalData() {
        const storedFavs = localStorage.getItem('wikiopy_favs');
        const storedTheme = localStorage.getItem('wikiopy_theme');
        favs = storedFavs ? JSON.parse(storedFavs) : [];
        themeOpt = storedTheme || 'system';
        applyTheme();
    }
    loadLocalData(); 

    function tokenize(s) {
      return (s || '').toLowerCase().normalize('NFKD').replace(/[̀-ͯ]/g, '').split(/[^a-z0-9]+/).filter(Boolean)
    }

    function score(item, toks) {
      const hay = tokenize([item.title, item.category, ...(item.tags || [])].join(' '))
      let hits = 0
      toks.forEach(t => { if (hay.includes(t)) hits += 2; else if (hay.some(h => h.startsWith(t))) hits += 1 })
      return hits
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>\"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]))
    }

    function toast(msg) {
      let el = $('#_toast')
      if (!el) {
        el = document.createElement('div')
        el.id = '_toast'
        el.style.cssText = 'position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:var(--card);color:var(--text);border:1px solid var(--line);padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,.2);z-index:9999'
        document.body.appendChild(el)
      }
      el.textContent = msg
      el.style.opacity = '1'
      clearTimeout(toast._t)
      toast._t = setTimeout(() => el.style.opacity = '0', 1600)
    }
    
    // ===================================
    // RENDER AND APP LOGIC
    // ===================================
    
    const state = { query: '', category: 'All' }

    function categories() {
      const set = new Set(topics.map(t => t.category))
      return ['All', ...Array.from(set)]
    }

    function renderPills() {
      const pills = $('#categoryPills')
      pills.innerHTML = ''
      const cats = categories()
      cats.forEach(cat => {
        const b = document.createElement('button')
        b.className = 'pill'
        b.textContent = cat
        if (cat === state.category) b.classList.add('active')
        b.addEventListener('click', () => { state.category = cat; renderAll() })
        pills.appendChild(b)
      })
    }
    
    function toggleFavorite(e) {
        const id = e.currentTarget.dataset.favId;
        if (favs.includes(id)) {
            favs = favs.filter(x => x !== id);
            e.currentTarget.innerHTML = '☆';
            toast('Removed from favorites');
        } else {
            favs.unshift(id); 
            e.currentTarget.innerHTML = '★';
            toast('Added to favorites');
        }
        localStorage.setItem('wikiopy_favs', JSON.stringify(favs));
        renderFavs();
    }

    function renderResults() {
      const toks = tokenize(state.query)
      let list = topics.map(t => ({ ...t, _score: toks.length ? score(t, toks) : 0 }))
      if (state.category !== 'All') list = list.filter(d => d.category === state.category)
      if (toks.length) list = list.filter(d => d._score > 0).sort((a, b) => b._score - a._score)
      else list = list.sort((a, b) => a.title.localeCompare(b.title))

      results.innerHTML = ''
      if (list.length === 0) {
        const div = document.createElement('div')
        div.className = 'panel'
        div.innerHTML = '<div class="center muted">No results yet.</div>'
        results.appendChild(div)
        return
      }

      list.forEach(item => {
        const art = document.createElement('article')
        art.className = 'card fadeUp'
        const isFav = favs.includes(item.id);
        art.innerHTML = `
          <div class="card-head">
            <div class="blob" aria-hidden="true"></div>
            <div class="grow">
              <div style="font-weight:700">${escapeHtml(item.title)}</div>
              <div class="muted" style="font-size:12px">${escapeHtml(item.category)}</div>
            </div>
            <button class="ghost fav-btn" data-fav-id="${item.id}" title="Toggle favorite">${isFav ? '★' : '☆'}</button>
          </div>
          <div class="mt-2" style="font-size:14px; line-height:1.5">${escapeHtml(item.summary)}</div>
          <div class="mt-2" style="display:flex; gap:6px; flex-wrap:wrap">${(item.tags || []).map(t => `<span class="tag">#${escapeHtml(t)}</span>`).join('')}</div>
          <div class="mt-2"><a class="btn primary" href="${escapeHtml(item.link || '#')}" target="_blank" rel="noreferrer">Learn more</a></div>
        `
        results.appendChild(art)
      })

      $$('.fav-btn').forEach(b => b.addEventListener('click', toggleFavorite))
    }

    function renderFavs() {
      const ul = $('#favsList')
      const empty = $('#favsEmpty')
      const items = favs.map(id => topics.find(t => t.id === id)).filter(Boolean).slice(0, 8)
      ul.innerHTML = ''
      if (items.length === 0) { empty.classList.remove('hidden'); return } else empty.classList.add('hidden')
      items.forEach(it => {
        const li = document.createElement('li')
        li.className = 'row'
        li.innerHTML = `<div class="blob" style="width:28px;height:28px;border-radius:10px"></div>
          <div class="grow"><div style="font-size:14px;font-weight:600">${escapeHtml(it.title)}</div><div class="muted" style="font-size:12px">${escapeHtml(it.category)}</div></div>
          <button class="ghost" data-unfav="${it.id}">✕</button>`
        ul.appendChild(li)
      })
      $$('[data-unfav]').forEach(b => b.addEventListener('click', () => {
        favs = favs.filter(x => x !== b.dataset.unfav)
        localStorage.setItem('wikiopy_favs', JSON.stringify(favs));
        renderResults(); renderFavs()
      }))
    }
    
    function renderAll() {
      renderPills()
      renderResults()
      renderFavs()
    }

    // ===================================
    // SUPABASE CRUD
    // ===================================
    
    // Fetch topics from Supabase (RLS will automatically filter for the current user)
    async function loadTopics() {
      if (!userId) return; // Prevent loading if not logged in
      const { data, error } = await supabase.from('topics').select('*').order('created_at', { ascending: false })
      if (error) {
        console.error('Error loading topics:', error)
        toast('Error loading topics: ' + error.message)
      } else {
        topics = data || []
        renderAll();
      }
    }

    // Add a new topic
    $('#addBtn').addEventListener('click', async () => {
      const title = $('#tTitle').value.trim()
      const summary = $('#tSummary').value.trim()
      if (title.length < 2 || summary.length < 10) return toast('Fill required fields')

      // Fix: Only send the data that should be inserted.
      // id, user_id, and created_at are handled by database defaults.
      const newTopicData = {
        title,
        category: $('#tCategory').value.trim() || 'General',
        tags: $('#tTags').value.split(',').map(s => s.trim()).filter(Boolean), 
        summary,
        link: $('#tLink').value.trim()
      }

      const { data, error } = await supabase.from('topics').insert([newTopicData]).select()
      if (error) {
        console.error('Failed to add topic:', error)
        toast('Failed to add topic: ' + error.message)
      } else {
        topics.unshift(data[0]) 
        $('#tTitle').value = $('#tCategory').value = $('#tTags').value = $('#tSummary').value = $('#tLink').value = ''
        renderAll()
        toast('Topic added successfully!')
      }
    })
    
    // ===================================
    // EVENT LISTENERS
    // ===================================
    searchInput.addEventListener('input', () => { state.query = searchInput.value; renderResults() })
    $('#resetBtn').addEventListener('click', () => { state.query = ''; searchInput.value = ''; state.category = 'All'; renderAll() })

    // Modals
    $$('[data-close]').forEach(b => b.addEventListener('click', (e) => $(`#${e.currentTarget.dataset.close}`).close()))
    $('#helpBtn').addEventListener('click', () => $('#helpModal').showModal())
    $('#settingsBtn').addEventListener('click', () => $('#settingsModal').showModal())
    
    // Start the app!
    checkAuth()
  </script>
</body>
</html>